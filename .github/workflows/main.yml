name: Compose Multiplatform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build & Test Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
'21'          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Run Android tests
        run: ./gradlew testDebugUnitTest
      
      - name: Build Android APK
        run: ./gradlew assembleDebug
      
      - name: Build Android AAB (Release)
        run: ./gradlew bundleRelease
        
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: androidApp/build/outputs/apk/debug/*.apk
      
      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: androidApp/build/outputs/bundle/release/*.aab

  build-ios:
    name: Build & Test iOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
'21'          cache: 'gradle'
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      
      - name: Install CocoaPods
        run: |
          cd iosApp
          pod install
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build iOS Framework
        run: ./gradlew linkDebugFrameworkIosSimulatorArm64
      
      - name: Run iOS tests
        run: ./gradlew iosSimulatorArm64Test
      
      - name: Build iOS App
        run: |
          cd iosApp
          xcodebuild -workspace iosApp.xcworkspace \
            -scheme iosApp \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            build

  deploy-android:
    name: Deploy Android to Play Store
    needs: build-android
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./artifacts
      
      - name: Deploy to Play Store (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.yourpackage.name
          releaseFiles: ./artifacts/*.aab
          track: internal
          status: completed

  deploy-ios:
    name: Deploy iOS to TestFlight
    needs: build-ios
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
Set up JDK 21        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
'21'          cache: 'gradle'
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      
      - name: Install CocoaPods
        run: |
          cd iosApp
          pod install
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build iOS Framework
        run: ./gradlew linkReleaseFrameworkIosArm64
      
      - name: Import Code Signing Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATES_P12 }}
          p12-password: ${{ secrets.IOS_CERTIFICATES_PASSWORD }}
      
      - name: Download Provisioning Profiles
        uses: apple-actions/download-provisioning-profiles@v2
        with:
          bundle-id: com.yourpackage.name
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      
      - name: Build & Archive iOS App
        run: |
          cd iosApp
          xcodebuild -workspace iosApp.xcworkspace \
            -scheme iosApp \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ./build/iosApp.xcarchive \
            archive
      
      - name: Export IPA
        run: |
          cd iosApp
          xcodebuild -exportArchive \
            -archivePath ./build/iosApp.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist exportOptions.plist
      
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: iosApp/build/iosApp.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
